[{"type":"Keyword","value":"import"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"isEmpty"},{"type":"Punctuator","value":"}"},{"type":"Identifier","value":"from"},{"type":"String","value":"'lodash'"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"import"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"getUserById"},{"type":"Identifier","value":"as"},{"type":"Identifier","value":"_getUserById"},{"type":"Punctuator","value":"}"},{"type":"Identifier","value":"from"},{"type":"String","value":"'../utils/user-stats'"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"import"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"getAccessTokenFromRequest"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"errorTypes"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"authHeaderNS"},{"type":"Punctuator","value":"}"},{"type":"Identifier","value":"from"},{"type":"String","value":"'../utils/getSetAccessToken'"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"import"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"homeLocation"},{"type":"Punctuator","value":"}"},{"type":"Identifier","value":"from"},{"type":"String","value":"'../../../config/env'"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"import"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"jwtSecret"},{"type":"Identifier","value":"as"},{"type":"Identifier","value":"_jwtSecret"},{"type":"Punctuator","value":"}"},{"type":"Identifier","value":"from"},{"type":"String","value":"'../../../config/secrets'"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"import"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"wrapHandledError"},{"type":"Punctuator","value":"}"},{"type":"Identifier","value":"from"},{"type":"String","value":"'../utils/create-handled-error'"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"const"},{"type":"Identifier","value":"apiProxyRE"},{"type":"Punctuator","value":"="},{"type":"RegularExpression","value":"/^\\/internal\\/|^\\/external\\//","regex":{"pattern":"^\\/internal\\/|^\\/external\\/","flags":""}},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"const"},{"type":"Identifier","value":"newsShortLinksRE"},{"type":"Punctuator","value":"="},{"type":"RegularExpression","value":"/^\\/internal\\/n\\/|^\\/internal\\/p\\?/","regex":{"pattern":"^\\/internal\\/n\\/|^\\/internal\\/p\\?","flags":""}},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"const"},{"type":"Identifier","value":"loopbackAPIPathRE"},{"type":"Punctuator","value":"="},{"type":"RegularExpression","value":"/^\\/internal\\/api\\//","regex":{"pattern":"^\\/internal\\/api\\/","flags":""}},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"const"},{"type":"Identifier","value":"_whiteListREs"},{"type":"Punctuator","value":"="},{"type":"Punctuator","value":"["},{"type":"Identifier","value":"newsShortLinksRE"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"loopbackAPIPathRE"},{"type":"Punctuator","value":"]"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"export"},{"type":"Keyword","value":"function"},{"type":"Identifier","value":"isWhiteListedPath"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"path"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"whiteListREs"},{"type":"Punctuator","value":"="},{"type":"Identifier","value":"_whiteListREs"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"return"},{"type":"Identifier","value":"whiteListREs"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"some"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"re"},{"type":"Punctuator","value":"=>"},{"type":"Identifier","value":"re"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"test"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"path"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Keyword","value":"export"},{"type":"Keyword","value":"default"},{"type":"Punctuator","value":"("},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"jwtSecret"},{"type":"Punctuator","value":"="},{"type":"Identifier","value":"_jwtSecret"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"getUserById"},{"type":"Punctuator","value":"="},{"type":"Identifier","value":"_getUserById"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":"="},{"type":"Punctuator","value":"{"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"=>"},{"type":"Keyword","value":"function"},{"type":"Identifier","value":"requestAuthorisation"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"req"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"res"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"next"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"const"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"path"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":"="},{"type":"Identifier","value":"req"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"if"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"apiProxyRE"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"test"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"path"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"&&"},{"type":"Punctuator","value":"!"},{"type":"Identifier","value":"isWhiteListedPath"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"path"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"const"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"accessToken"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"error"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"jwt"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":"="},{"type":"Identifier","value":"getAccessTokenFromRequest"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"req"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"jwtSecret"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"if"},{"type":"Punctuator","value":"("},{"type":"Punctuator","value":"!"},{"type":"Identifier","value":"accessToken"},{"type":"Punctuator","value":"&&"},{"type":"Identifier","value":"error"},{"type":"Punctuator","value":"==="},{"type":"Identifier","value":"errorTypes"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"noTokenFound"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"throw"},{"type":"Identifier","value":"wrapHandledError"},{"type":"Punctuator","value":"("},{"type":"Keyword","value":"new"},{"type":"Identifier","value":"Error"},{"type":"Punctuator","value":"("},{"type":"String","value":"'Access token is required for this request'"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":","},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"type"},{"type":"Punctuator","value":":"},{"type":"String","value":"'info'"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"redirect"},{"type":"Punctuator","value":":"},{"type":"Template","value":"`${"},{"type":"Identifier","value":"homeLocation"},{"type":"Template","value":"}/signin`"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"message"},{"type":"Punctuator","value":":"},{"type":"String","value":"'Access token is required for this request'"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"status"},{"type":"Punctuator","value":":"},{"type":"Numeric","value":"403"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Keyword","value":"if"},{"type":"Punctuator","value":"("},{"type":"Punctuator","value":"!"},{"type":"Identifier","value":"accessToken"},{"type":"Punctuator","value":"&&"},{"type":"Identifier","value":"error"},{"type":"Punctuator","value":"==="},{"type":"Identifier","value":"errorTypes"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"invalidToken"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"throw"},{"type":"Identifier","value":"wrapHandledError"},{"type":"Punctuator","value":"("},{"type":"Keyword","value":"new"},{"type":"Identifier","value":"Error"},{"type":"Punctuator","value":"("},{"type":"String","value":"'Access token is invalid'"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":","},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"type"},{"type":"Punctuator","value":":"},{"type":"String","value":"'info'"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"redirect"},{"type":"Punctuator","value":":"},{"type":"Template","value":"`${"},{"type":"Identifier","value":"homeLocation"},{"type":"Template","value":"}/signin`"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"message"},{"type":"Punctuator","value":":"},{"type":"String","value":"'Your access token is invalid'"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"status"},{"type":"Punctuator","value":":"},{"type":"Numeric","value":"403"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Keyword","value":"if"},{"type":"Punctuator","value":"("},{"type":"Punctuator","value":"!"},{"type":"Identifier","value":"accessToken"},{"type":"Punctuator","value":"&&"},{"type":"Identifier","value":"error"},{"type":"Punctuator","value":"==="},{"type":"Identifier","value":"errorTypes"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"expiredToken"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"throw"},{"type":"Identifier","value":"wrapHandledError"},{"type":"Punctuator","value":"("},{"type":"Keyword","value":"new"},{"type":"Identifier","value":"Error"},{"type":"Punctuator","value":"("},{"type":"String","value":"'Access token is no longer vaild'"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":","},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"type"},{"type":"Punctuator","value":":"},{"type":"String","value":"'info'"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"redirect"},{"type":"Punctuator","value":":"},{"type":"Template","value":"`${"},{"type":"Identifier","value":"homeLocation"},{"type":"Template","value":"}/signin`"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"message"},{"type":"Punctuator","value":":"},{"type":"String","value":"'Access token is no longer vaild'"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"status"},{"type":"Punctuator","value":":"},{"type":"Numeric","value":"403"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Identifier","value":"res"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"set"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"authHeaderNS"},{"type":"Punctuator","value":","},{"type":"Identifier","value":"jwt"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"if"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"isEmpty"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"req"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"user"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"const"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"userId"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":"="},{"type":"Identifier","value":"accessToken"},{"type":"Punctuator","value":";"},{"type":"Keyword","value":"return"},{"type":"Identifier","value":"getUserById"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"userId"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"then"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"user"},{"type":"Punctuator","value":"=>"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"if"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"user"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"{"},{"type":"Identifier","value":"req"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"user"},{"type":"Punctuator","value":"="},{"type":"Identifier","value":"user"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Keyword","value":"return"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"then"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"next"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":"."},{"type":"Keyword","value":"catch"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"next"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Keyword","value":"else"},{"type":"Punctuator","value":"{"},{"type":"Keyword","value":"return"},{"type":"Identifier","value":"Promise"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"resolve"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"next"},{"type":"Punctuator","value":"("},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":"}"},{"type":"Keyword","value":"return"},{"type":"Identifier","value":"Promise"},{"type":"Punctuator","value":"."},{"type":"Identifier","value":"resolve"},{"type":"Punctuator","value":"("},{"type":"Identifier","value":"next"},{"type":"Punctuator","value":"("},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":")"},{"type":"Punctuator","value":";"},{"type":"Punctuator","value":"}"},{"type":"Punctuator","value":";"}]